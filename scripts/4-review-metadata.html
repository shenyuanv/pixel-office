<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Asset Review & Metadata Editor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body { background: #1a1a2e; color: #e0e0e0; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; flex-direction: column; overflow: hidden; }

    #toolbar { padding: 10px 16px; background: #16213e; border-bottom: 1px solid #333; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    #toolbar button, #toolbar input { font-size: 12px; padding: 6px 12px; border-radius: 3px; border: 1px solid #555; background: #2a2a4a; color: #e0e0e0; cursor: pointer; }
    #toolbar button:hover { background: #1a5276; }
    #toolbar button.primary { background: #27ae60; border-color: #2ecc71; font-weight: 600; }
    #toolbar button.primary:hover { background: #2ecc71; }
    .sep { width: 1px; height: 24px; background: #444; }

    #main { flex: 1; display: flex; gap: 12px; padding: 12px; min-height: 0; overflow: hidden; }

    /* Left: Asset List */
    #list-panel { width: 280px; display: flex; flex-direction: column; background: #0f3460; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    #list-panel h3 { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #333; background: #16213e; }
    #search-box { padding: 6px 8px; }
    #search-box input { width: 100%; padding: 6px; background: #2a2a4a; border: 1px solid #555; color: #e0e0e0; border-radius: 2px; font-size: 11px; }
    #asset-list { flex: 1; overflow-y: auto; padding: 4px 0; }
    .asset-item {
      padding: 8px 12px; margin: 2px 4px; border-radius: 2px; cursor: pointer; display: flex; gap: 8px; align-items: center; background: #1a1a3e; border: 1px solid transparent; transition: all 0.2s;
    }
    .asset-item:hover { border-color: #555; background: #1a2a4e; }
    .asset-item.selected { border-color: #3498db; background: #1a3a5e; box-shadow: 0 0 8px rgba(52, 152, 219, 0.3); }
    .asset-item.discarded { opacity: 0.5; }
    .asset-thumb { width: 40px; height: 40px; flex-shrink: 0; image-rendering: pixelated; background: #000; border: 1px solid #444; border-radius: 1px; }
    .asset-label { flex: 1; min-width: 0; }
    .asset-label .name { font-weight: 600; font-size: 11px; color: #eee; }
    .asset-label .cat { font-size: 9px; color: #888; }
    #list-buttons { padding: 8px 4px; border-top: 1px solid #333; display: flex; gap: 4px; }
    #list-buttons button { flex: 1; padding: 4px 8px; font-size: 10px; }

    /* Center: Preview */
    #preview-panel { flex: 0 0 300px; display: flex; flex-direction: column; background: #0f3460; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    #preview-panel h3 { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #333; background: #16213e; }
    #preview-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px; }
    #preview-canvas { image-rendering: pixelated; max-width: 100%; max-height: 100%; border: 2px solid #3498db; background: #000; }

    /* Right: Editor */
    #editor-panel { flex: 1; display: flex; flex-direction: column; background: #0f3460; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    #editor-panel h3 { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid #333; background: #16213e; }
    #editor-form { flex: 1; overflow-y: auto; padding: 12px; }
    .field { margin-bottom: 14px; }
    .field-label { font-size: 10px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; font-weight: 600; }
    .field input, .field select { width: 100%; padding: 6px 8px; background: #2a2a4a; border: 1px solid #555; color: #e0e0e0; border-radius: 2px; font-size: 11px; }
    .field input:focus, .field select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 4px rgba(52, 152, 219, 0.3); }
    .field input[readonly] { background: #1a1a3e; cursor: not-allowed; }
    .field-row { display: flex; gap: 8px; }
    .field-row input { flex: 1; }
    .checkbox-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .checkbox-item { display: flex; align-items: center; gap: 6px; }
    .checkbox-item input { width: 16px; height: 16px; cursor: pointer; flex-shrink: 0; }
    .checkbox-item label { cursor: pointer; font-size: 11px; flex: 1; }
    .discard-section { padding: 8px; margin-top: 8px; background: #6b2020; border-radius: 2px; }
    .discard-section label { color: #ffaa99; }
    #editor-buttons { padding: 12px; border-top: 1px solid #333; display: flex; gap: 8px; }
    #editor-buttons button { flex: 1; padding: 6px 12px; font-size: 11px; }

    #status { padding: 8px 16px; background: #16213e; font-size: 11px; color: #888; border-top: 1px solid #333; }
  </style>
</head>
<body>

<div id="toolbar">
  <button id="btn-load-json">üìÇ Load Metadata JSON</button>
  <button id="btn-load-png">üì∑ Load Tileset PNG</button>
  <span class="sep"></span>
  <label style="font-size: 11px; color: #aaa;">Filter:</label>
  <select id="filter-cat" style="width: 100px; font-size: 11px;">
    <option value="">All</option>
    <option value="desks">Desks</option>
    <option value="chairs">Chairs</option>
    <option value="storage">Storage</option>
    <option value="decor">Decor</option>
    <option value="electronics">Electronics</option>
    <option value="misc">Misc</option>
  </select>
  <span class="sep"></span>
  <span id="progress" style="font-size: 11px; color: #aaa; min-width: 80px; text-align: right;"></span>
  <button class="primary" id="btn-export" style="margin-left: auto;">‚úì Export Final</button>
</div>

<div id="main">
  <!-- List -->
  <div id="list-panel">
    <h3>Assets (<span id="count">0</span>)</h3>
    <div id="search-box">
      <input type="text" id="search" placeholder="Search by name...">
    </div>
    <div id="asset-list"></div>
    <div id="list-buttons">
      <button id="btn-prev">‚Üê Prev</button>
      <button id="btn-next">Next ‚Üí</button>
    </div>
  </div>

  <!-- Preview -->
  <div id="preview-panel">
    <h3>Preview</h3>
    <div id="preview-container">
      <canvas id="preview-canvas"></canvas>
    </div>
  </div>

  <!-- Editor -->
  <div id="editor-panel">
    <h3>Edit Metadata</h3>
    <div id="editor-form">
      <div class="field">
        <label class="field-label">ID</label>
        <input id="f-id" type="text" readonly>
      </div>

      <div class="field">
        <label class="field-label">Name</label>
        <input id="f-name" type="text" placeholder="e.g., DESK_WOOD_SM">
      </div>

      <div class="field">
        <label class="field-label">Label</label>
        <input id="f-label" type="text" placeholder="e.g., Wood Desk Small">
      </div>

      <div class="field">
        <label class="field-label">Category</label>
        <select id="f-category">
          <option value="desks">Desks</option>
          <option value="chairs">Chairs</option>
          <option value="storage">Storage</option>
          <option value="decor">Decor</option>
          <option value="electronics">Electronics</option>
          <option value="misc">Misc</option>
        </select>
      </div>

      <div class="field">
        <label class="field-label">Footprint (tiles)</label>
        <div class="field-row">
          <input id="f-fpw" type="number" min="1" max="10" placeholder="Width">
          <input id="f-fph" type="number" min="1" max="10" placeholder="Height">
        </div>
      </div>

      <div class="field">
        <label class="field-label">Flags</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input id="f-isdesk" type="checkbox">
            <label for="f-isdesk">Is Desk</label>
          </div>
          <div class="checkbox-item">
            <input id="f-walls" type="checkbox">
            <label for="f-walls">Can Place On Walls</label>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="field-label">Grouping</label>
        <div class="checkbox-item">
          <input id="f-grouped" type="checkbox">
          <label for="f-grouped">Part of something bigger</label>
        </div>
        <input id="f-group-id" type="text" placeholder="e.g., CHAIR_1, TABLE_SET_A" style="margin-top: 4px; width: 100%; padding: 4px 6px; background: #2a2a4a; border: 1px solid #555; color: #e0e0e0; border-radius: 2px; font-size: 10px; display: none;">
      </div>

      <div class="field">
        <label class="field-label">Placement</label>
        <div class="checkbox-item">
          <input id="f-ontop" type="checkbox">
          <label for="f-ontop">Can be placed on surfaces</label>
        </div>
      </div>

      <div class="field discard-section">
        <div class="checkbox-item">
          <input id="f-discard" type="checkbox">
          <label for="f-discard" style="color: #ffaa99; font-weight: 600;">Mark as Discard</label>
        </div>
      </div>
    </div>

    <div id="editor-buttons">
      <button id="btn-save" class="primary">üíæ Save</button>
      <button id="btn-reset">‚Ü∫ Reset</button>
    </div>
  </div>
</div>

<div id="status">Ready</div>

<input type="file" id="json-file" accept="application/json" style="display:none;">
<input type="file" id="png-file" accept="image/png" style="display:none;">

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let metadata = null
let tilesetImg = null
let selectedIdx = -1
let filtered = []
let filterCat = ''

const status = document.getElementById('status')
const progress = document.getElementById('progress')
const count = document.getElementById('count')
const assetList = document.getElementById('asset-list')
const previewCanvas = document.getElementById('preview-canvas')
const previewCtx = previewCanvas.getContext('2d')

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('btn-load-json').onclick = () => document.getElementById('json-file').click()
document.getElementById('json-file').onchange = (e) => {
  const file = e.target.files[0]
  if (!file) return
  const reader = new FileReader()
  reader.onload = (ev) => {
    try {
      metadata = JSON.parse(ev.target.result)
      selectedIdx = 0
      updateFilter()
      selectAsset(0)
      status.textContent = `‚úì Loaded ${metadata.assets.length} assets`
      localStorage.setItem('review-metadata', JSON.stringify(metadata))
    } catch (err) {
      alert('Invalid JSON: ' + err.message)
    }
  }
  reader.readAsText(file)
}

document.getElementById('btn-load-png').onclick = () => document.getElementById('png-file').click()
document.getElementById('png-file').onchange = (e) => {
  const file = e.target.files[0]
  if (!file) return
  const reader = new FileReader()
  reader.onload = (ev) => {
    const img = new Image()
    img.onload = () => {
      tilesetImg = img
      renderPreview()
      status.textContent = `‚úì Tileset loaded`
    }
    img.src = ev.target.result
  }
  reader.readAsDataURL(file)
}

// Auto-load
window.addEventListener('load', () => {
  try {
    const saved = localStorage.getItem('review-metadata')
    if (saved) {
      metadata = JSON.parse(saved)
      selectedIdx = 0
      updateFilter()
      selectAsset(0)
    }
  } catch {}
})

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('filter-cat').onchange = (e) => {
  filterCat = e.target.value
  updateFilter()
}

document.getElementById('search').oninput = () => {
  updateFilter()
}

function updateFilter() {
  if (!metadata) return

  const search = document.getElementById('search').value.toLowerCase()
  filtered = []

  metadata.assets.forEach((asset, idx) => {
    const matchCat = !filterCat || asset.category === filterCat
    const matchSearch =
      !search ||
      asset.name.toLowerCase().includes(search) ||
      asset.label.toLowerCase().includes(search)

    if (matchCat && matchSearch) {
      filtered.push(idx)
    }
  })

  renderList()
  count.textContent = filtered.length
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('btn-prev').onclick = () => {
  const pos = filtered.indexOf(selectedIdx)
  if (pos > 0) selectAsset(filtered[pos - 1])
}

document.getElementById('btn-next').onclick = () => {
  const pos = filtered.indexOf(selectedIdx)
  if (pos < filtered.length - 1) selectAsset(filtered[pos + 1])
}

function selectAsset(idx) {
  if (!metadata || idx < 0 || idx >= metadata.assets.length) return

  selectedIdx = idx
  const asset = metadata.assets[idx]

  // Update form
  document.getElementById('f-id').value = asset.id
  document.getElementById('f-name').value = asset.name
  document.getElementById('f-label').value = asset.label
  document.getElementById('f-category').value = asset.category
  document.getElementById('f-fpw').value = asset.footprintW
  document.getElementById('f-fph').value = asset.footprintH
  document.getElementById('f-isdesk').checked = asset.isDesk
  document.getElementById('f-walls').checked = asset.canPlaceOnWalls
  document.getElementById('f-grouped').checked = asset.partOfGroup || false
  document.getElementById('f-group-id').value = asset.groupId || ''
  document.getElementById('f-group-id').style.display = (asset.partOfGroup || false) ? 'block' : 'none'
  document.getElementById('f-ontop').checked = asset.canPlaceOnSurfaces || false
  document.getElementById('f-discard').checked = asset.discard

  // Update progress
  const pos = filtered.indexOf(idx)
  progress.textContent = `${pos + 1} / ${filtered.length}`

  renderList()
  renderPreview()
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE & RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('btn-save').onclick = () => {
  if (selectedIdx < 0 || !metadata) return

  const asset = metadata.assets[selectedIdx]
  asset.name = document.getElementById('f-name').value.trim() || asset.name
  asset.label = document.getElementById('f-label').value.trim() || asset.label
  asset.category = document.getElementById('f-category').value
  asset.footprintW = +document.getElementById('f-fpw').value || asset.footprintW
  asset.footprintH = +document.getElementById('f-fph').value || asset.footprintH
  asset.isDesk = document.getElementById('f-isdesk').checked
  asset.canPlaceOnWalls = document.getElementById('f-walls').checked
  asset.partOfGroup = document.getElementById('f-grouped').checked
  asset.groupId = document.getElementById('f-group-id').value.trim() || null
  asset.canPlaceOnSurfaces = document.getElementById('f-ontop').checked
  asset.discard = document.getElementById('f-discard').checked

  localStorage.setItem('review-metadata', JSON.stringify(metadata))
  renderList()
  status.textContent = `‚úì Saved: ${asset.name}`
}

document.getElementById('btn-reset').onclick = () => {
  if (selectedIdx < 0) return
  selectAsset(selectedIdx) // Reload from metadata
  status.textContent = 'Reset to saved version'
}

// Show/hide groupId input based on checkbox
document.getElementById('f-grouped').onchange = (e) => {
  document.getElementById('f-group-id').style.display = e.target.checked ? 'block' : 'none'
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('btn-export').onclick = () => {
  if (!metadata) return

  const approved = metadata.assets.filter((a) => !a.discard)
  const output = {
    version: 1,
    timestamp: new Date().toISOString(),
    sourceFile: metadata.sourceFile,
    tileset: metadata.tileset,
    backgroundColor: metadata.backgroundColor,
    assets: approved,
  }

  const json = JSON.stringify(output, null, 2)
  const blob = new Blob([json], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = 'tileset-metadata-final.json'
  a.click()
  URL.revokeObjectURL(url)

  status.textContent = `‚úì Exported ${approved.length} assets (${metadata.assets.length - approved.length} discarded)`
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderList() {
  if (!metadata) return

  assetList.innerHTML = ''
  filtered.forEach((idx) => {
    const asset = metadata.assets[idx]
    const div = document.createElement('div')
    div.className = 'asset-item' + (idx === selectedIdx ? ' selected' : '') + (asset.discard ? ' discarded' : '')
    div.onclick = () => selectAsset(idx)

    // Thumb
    const thumb = document.createElement('canvas')
    thumb.width = 40
    thumb.height = 40
    thumb.className = 'asset-thumb'
    if (tilesetImg) {
      const tctx = thumb.getContext('2d')
      tctx.imageSmoothingEnabled = false
      const s = Math.min(40 / asset.paddedWidth, 40 / asset.paddedHeight)
      const dw = asset.paddedWidth * s
      const dh = asset.paddedHeight * s
      tctx.drawImage(
        tilesetImg,
        asset.paddedX, asset.paddedY, asset.paddedWidth, asset.paddedHeight,
        (40 - dw) / 2, (40 - dh) / 2, dw, dh
      )
    }
    div.appendChild(thumb)

    const label = document.createElement('div')
    label.className = 'asset-label'
    label.innerHTML = `<div class="name">${asset.name}</div><div class="cat">${asset.category}</div>`
    div.appendChild(label)

    assetList.appendChild(div)
  })
}

function renderPreview() {
  if (!metadata || selectedIdx < 0 || !tilesetImg) return

  const asset = metadata.assets[selectedIdx]
  const zoom = 4

  previewCanvas.width = asset.paddedWidth * zoom
  previewCanvas.height = asset.paddedHeight * zoom
  previewCtx.imageSmoothingEnabled = false

  previewCtx.drawImage(
    tilesetImg,
    asset.paddedX, asset.paddedY, asset.paddedWidth, asset.paddedHeight,
    0, 0, previewCanvas.width, previewCanvas.height
  )

  // Grid
  previewCtx.strokeStyle = 'rgba(255,255,255,0.15)'
  previewCtx.lineWidth = 1
  for (let x = 0; x <= previewCanvas.width; x += 16 * zoom) {
    previewCtx.beginPath()
    previewCtx.moveTo(x, 0)
    previewCtx.lineTo(x, previewCanvas.height)
    previewCtx.stroke()
  }
  for (let y = 0; y <= previewCanvas.height; y += 16 * zoom) {
    previewCtx.beginPath()
    previewCtx.moveTo(0, y)
    previewCtx.lineTo(previewCanvas.width, y)
    previewCtx.stroke()
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.onkeydown = (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return
  if (e.key === 'ArrowUp') {
    const pos = filtered.indexOf(selectedIdx)
    if (pos > 0) selectAsset(filtered[pos - 1])
  } else if (e.key === 'ArrowDown') {
    const pos = filtered.indexOf(selectedIdx)
    if (pos < filtered.length - 1) selectAsset(filtered[pos + 1])
  } else if (e.key === 'Enter') {
    document.getElementById('btn-save').click()
  }
}
</script>
</body>
</html>
