<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel Agents JSONL Log Viewer</title>
<style>
  :root {
    --bg: #0d1117;
    --bg2: #161b22;
    --bg3: #1c2128;
    --border: #30363d;
    --text: #c9d1d9;
    --text-dim: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --red: #f85149;
    --orange: #d29922;
    --purple: #bc8cff;
    --yellow: #e3b341;
    --cyan: #39d2c0;
    --pink: #f778ba;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* ── Header ── */
  header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  header h1 { font-size: 16px; font-weight: 600; }
  header h1 span { color: var(--accent); }

  .hdr-btn {
    background: var(--bg3);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
  }
  .hdr-btn:hover { border-color: var(--text-dim); }
  .hdr-btn.primary { background: var(--accent); color: #000; border-color: var(--accent); }
  .hdr-btn.primary:hover { opacity: 0.9; }

  .hdr-back {
    background: none;
    border: none;
    color: var(--accent);
    font-size: 13px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    display: none;
  }
  .hdr-back:hover { background: var(--bg3); }

  .hdr-path {
    font-size: 11px;
    color: var(--text-dim);
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 400px;
  }

  .hdr-stats {
    margin-left: auto;
    display: flex;
    gap: 14px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .hdr-stats .sv { color: var(--text); font-weight: 600; }

  /* ── Views ── */
  .view { display: none; flex: 1; overflow: hidden; }
  .view.active { display: flex; }

  /* ── Drop zone ── */
  #viewEmpty { align-items: center; justify-content: center; }
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 50px 60px;
    text-align: center;
    max-width: 550px;
  }
  .drop-zone h2 { color: var(--text); margin-bottom: 6px; font-size: 18px; }
  .drop-zone p { color: var(--text-dim); font-size: 13px; margin-bottom: 12px; }
  .drop-zone .btns { display: flex; gap: 10px; justify-content: center; margin-top: 18px; }
  .drop-zone.drag-over { border-color: var(--accent); background: rgba(88,166,255,0.05); }

  /* ── Session browser ── */
  .sessions-sidebar {
    width: 320px;
    min-width: 240px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }
  .sessions-sidebar-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .sessions-sidebar-header .count { color: var(--text); font-weight: 600; }
  .sessions-search {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    flex: 1;
    min-width: 0;
  }
  .sessions-search::placeholder { color: var(--text-dim); }
  .sessions-list { flex: 1; overflow-y: auto; }

  .session-card {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }
  .session-card:hover { background: var(--bg2); }
  .session-card.selected { background: var(--bg3); border-left: 3px solid var(--accent); }
  .session-card-name {
    font-size: 12px;
    font-family: monospace;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .session-card-meta {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 3px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .session-card-preview {
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-style: italic;
  }

  .sessions-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .convo-header {
    padding: 10px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
    background: var(--bg2);
  }
  .convo-header-name {
    font-size: 13px;
    font-weight: 600;
    font-family: monospace;
  }
  .convo-header .hdr-btn { font-size: 11px; padding: 4px 10px; }
  .convo-header-spacer { flex: 1; }

  .convo-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
  }
  .convo-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-dim);
    font-size: 14px;
  }

  /* ── Conversation messages ── */
  .convo-msg {
    margin-bottom: 16px;
    max-width: 900px;
  }
  .convo-msg-role {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    padding-left: 2px;
  }
  .convo-msg-role.user { color: var(--accent); }
  .convo-msg-role.assistant { color: var(--green); }

  .convo-msg-body {
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .convo-msg.user .convo-msg-body {
    background: #111d2e;
    border: 1px solid #1f3a5f;
  }
  .convo-msg.assistant .convo-msg-body {
    background: var(--bg2);
    border: 1px solid var(--border);
  }

  .convo-msg-truncated {
    max-height: 260px;
    overflow: hidden;
    position: relative;
  }
  .convo-msg-truncated::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: linear-gradient(transparent, var(--bg2));
    pointer-events: none;
  }
  .convo-msg.user .convo-msg-truncated::after {
    background: linear-gradient(transparent, #111d2e);
  }

  .convo-expand-btn {
    background: none;
    border: none;
    color: var(--accent);
    font-size: 12px;
    cursor: pointer;
    padding: 4px 0;
    margin-top: 2px;
  }
  .convo-expand-btn:hover { text-decoration: underline; }

  .convo-tools {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border);
  }
  .convo-tool-pill {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 3px;
    background: var(--bg3);
    color: var(--text-dim);
    font-weight: 600;
  }

  .convo-jump-btn {
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 11px;
    cursor: pointer;
    padding: 2px 6px;
    border-radius: 3px;
    margin-left: auto;
  }
  .convo-jump-btn:hover { color: var(--accent); background: var(--bg3); }

  .convo-turn-sep {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 20px 0;
    max-width: 900px;
  }
  .convo-turn-sep::before, .convo-turn-sep::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .convo-turn-sep span {
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* ── Code in conversation ── */
  .convo-msg-body pre {
    background: var(--bg);
    border-radius: 4px;
    padding: 8px 10px;
    margin: 6px 0;
    overflow-x: auto;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 12px;
    white-space: pre;
    line-height: 1.5;
  }
  .convo-msg-body code {
    background: var(--bg);
    padding: 1px 5px;
    border-radius: 3px;
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 12px;
  }
  .convo-msg-body pre code { background: none; padding: 0; }

  /* ── JSONL Detail view ── */
  .detail-wrap { display: flex; flex: 1; overflow: hidden; flex-direction: column; }

  .filter-bar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 8px 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .filter-bar label { font-size: 12px; color: var(--text-dim); display: flex; align-items: center; gap: 4px; cursor: pointer; }
  .filter-bar input[type="checkbox"] { accent-color: var(--accent); }
  .filter-search {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
    width: 200px;
    margin-left: auto;
  }
  .filter-search::placeholder { color: var(--text-dim); }

  .timeline-bar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 6px 14px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    overflow-x: auto;
  }
  .timeline-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; cursor: pointer; transition: transform 0.1s;
  }
  .timeline-dot:hover { transform: scale(1.8); }
  .timeline-dot.selected { transform: scale(2); box-shadow: 0 0 0 2px var(--text); }
  .timeline-dot.td-assistant { background: var(--accent); }
  .timeline-dot.td-user { background: var(--green); }
  .timeline-dot.td-system { background: var(--orange); }
  .timeline-dot.td-progress { background: var(--purple); }
  .timeline-dot.td-unknown { background: var(--text-dim); }

  .detail-body { display: flex; flex: 1; overflow: hidden; }

  .record-list {
    width: 440px;
    min-width: 300px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    flex-shrink: 0;
  }
  .record-item {
    padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 13px;
    transition: background 0.1s;
  }
  .record-item:hover { background: var(--bg2); }
  .record-item.selected { background: var(--bg3); border-left: 3px solid var(--accent); }
  .record-index { color: var(--text-dim); font-family: monospace; font-size: 11px; min-width: 32px; text-align: right; padding-top: 2px; flex-shrink: 0; }
  .record-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; flex-shrink: 0; min-width: 70px; text-align: center; }
  .badge-assistant { background: #1f3a5f; color: var(--accent); }
  .badge-user { background: #1a3a1a; color: var(--green); }
  .badge-system { background: #3a2a1a; color: var(--orange); }
  .badge-progress { background: #2a1a3a; color: var(--purple); }
  .badge-unknown { background: var(--bg3); color: var(--text-dim); }

  .record-summary { flex: 1; min-width: 0; }
  .record-summary-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); font-size: 12px; }
  .record-summary-sub { font-size: 11px; color: var(--text-dim); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .state-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
  .state-badge { font-size: 10px; padding: 1px 6px; border-radius: 3px; font-weight: 600; white-space: nowrap; }
  .sb-tool-start { background: #1f3a5f; color: #79c0ff; }
  .sb-tool-done { background: #1a3a1a; color: #7ee787; }
  .sb-turn-end { background: #3a2a1a; color: #ffa657; }
  .sb-waiting { background: #2a3a1a; color: var(--green); }
  .sb-new-turn { background: #1a2a3a; color: var(--cyan); }
  .sb-permission-start { background: #3a1a2a; color: var(--pink); }
  .sb-permission-restart { background: #3a1a2a; color: var(--pink); border: 1px dashed var(--pink); }
  .sb-text-idle-start { background: #2a2a1a; color: var(--yellow); }
  .sb-active { background: #1f3a5f; color: var(--accent); }
  .sb-cancel-waiting { background: #2a1a1a; color: var(--red); }
  .sb-cancel-permission { background: #2a1a1a; color: var(--red); }
  .sb-clear-activity { background: #2a1a1a; color: var(--red); }
  .sb-subagent { background: #2a1a3a; color: var(--purple); }

  .detail-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .detail-header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 8px 20px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
  .detail-tabs { display: flex; gap: 2px; }
  .detail-tab { background: transparent; color: var(--text-dim); border: none; padding: 5px 12px; font-size: 12px; cursor: pointer; border-radius: 4px; }
  .detail-tab:hover { background: var(--bg3); color: var(--text); }
  .detail-tab.active { background: var(--bg3); color: var(--text); font-weight: 600; }
  .detail-content { flex: 1; overflow-y: auto; padding: 16px 20px; }
  .detail-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); font-size: 14px; }

  /* ── JSON tree ── */
  .json-tree { font-family: 'Cascadia Code', 'Fira Code', monospace; font-size: 13px; line-height: 1.6; }
  .json-key { color: #79c0ff; }
  .json-string { color: #a5d6ff; }
  .json-number { color: #ffa657; }
  .json-boolean { color: var(--purple); }
  .json-null { color: var(--text-dim); }
  .json-bracket { color: var(--text-dim); }
  .json-toggle { cursor: pointer; user-select: none; display: inline-block; width: 14px; text-align: center; color: var(--text-dim); }
  .json-toggle:hover { color: var(--text); }
  .json-collapsed { display: none; }
  .json-collapsible { margin-left: 20px; }

  /* ── Parsed/state detail ── */
  .parsed-section { margin-bottom: 20px; }
  .parsed-section h3 { font-size: 13px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
  .parsed-field { display: flex; gap: 12px; padding: 4px 0; font-size: 13px; }
  .parsed-label { color: var(--text-dim); min-width: 120px; flex-shrink: 0; }
  .parsed-value { color: var(--text); font-family: 'Cascadia Code', 'Fira Code', monospace; word-break: break-all; }
  .tool-block { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 14px; margin-bottom: 8px; }
  .tool-block-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .tool-name { font-weight: 600; color: var(--accent); font-size: 13px; }
  .tool-id { font-size: 11px; color: var(--text-dim); font-family: monospace; }
  .tool-input { background: var(--bg); border-radius: 4px; padding: 8px 10px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
  .text-content { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 12px 16px; font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-break: break-word; max-height: 400px; overflow-y: auto; }
  .state-overlay-detail { background: var(--bg2); border: 1px solid var(--border); border-radius: 6px; padding: 14px 18px; margin-bottom: 12px; }
  .state-overlay-detail h3 { font-size: 14px; margin-bottom: 10px; color: var(--accent); }
  .state-event { display: flex; align-items: flex-start; gap: 10px; padding: 6px 0; border-bottom: 1px solid #21262d; font-size: 13px; }
  .state-event:last-child { border-bottom: none; }
  .state-event-icon { font-size: 14px; flex-shrink: 0; width: 20px; text-align: center; }
  .state-event-text { flex: 1; }
  .state-event-text .reason { color: var(--text-dim); font-size: 12px; display: block; margin-top: 2px; }
  .state-snapshot { background: var(--bg); border-radius: 4px; padding: 10px 14px; font-family: monospace; font-size: 12px; line-height: 1.6; }
  .state-field { display: flex; gap: 8px; }
  .state-field-name { color: var(--text-dim); min-width: 180px; }
  .state-true { color: var(--green); }
  .state-false { color: var(--red); }
  .state-set-empty { color: var(--text-dim); font-style: italic; }
  .state-set-items { color: var(--accent); }

  /* ── Legend ── */
  .detail-legend {
    background: var(--bg2);
    border-top: 1px solid var(--border);
    padding: 5px 14px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    flex-shrink: 0;
    font-size: 11px;
  }
  .legend-item { display: flex; align-items: center; gap: 4px; color: var(--text-dim); }
  .legend-swatch { width: 10px; height: 10px; border-radius: 2px; }

  .resizer { width: 4px; background: var(--border); cursor: col-resize; flex-shrink: 0; }
  .resizer:hover { background: var(--accent); }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
</style>
</head>
<body>

<header>
  <button class="hdr-back" id="backBtn">← Back</button>
  <h1><span>Pixel Agents</span> JSONL Viewer</h1>
  <span class="hdr-path" id="hdrPath"></span>
  <div class="hdr-stats" id="hdrStats"></div>
</header>

<!-- ─── View: Empty / Drop zone ─── -->
<div class="view active" id="viewEmpty">
  <div class="drop-zone" id="dropZone">
    <h2>Open a JSONL project folder</h2>
    <p>Load a folder to browse sessions, or a single file to inspect it</p>
    <p style="font-size:11px;color:var(--text-dim);margin-bottom:4px">
      Sessions live at: <code>~/.claude/projects/&lt;hash&gt;/</code>
    </p>
    <div class="btns">
      <button class="hdr-btn primary" id="openFolderBtn">Open Folder</button>
      <button class="hdr-btn" id="openFileBtn">Open File</button>
    </div>
  </div>
</div>

<!-- ─── View: Session browser ─── -->
<div class="view" id="viewSessions">
  <div class="sessions-sidebar">
    <div class="sessions-sidebar-header">
      <span>Sessions: <span class="count" id="sessionCount">0</span></span>
      <input type="text" class="sessions-search" id="sessionSearch" placeholder="Filter sessions...">
    </div>
    <div class="sessions-list" id="sessionsList"></div>
  </div>
  <div class="sessions-main">
    <div class="convo-header" id="convoHeader" style="display:none">
      <span class="convo-header-name" id="convoName"></span>
      <div class="convo-header-spacer"></div>
      <button class="hdr-btn" id="viewJsonlBtn">View Full JSONL →</button>
    </div>
    <div class="convo-body" id="convoBody">
      <div class="convo-placeholder">Select a session to preview</div>
    </div>
  </div>
</div>

<!-- ─── View: JSONL detail ─── -->
<div class="view" id="viewDetail">
  <div class="detail-wrap">
    <div class="filter-bar">
      <label><input type="checkbox" checked data-filter="assistant"> assistant</label>
      <label><input type="checkbox" checked data-filter="user"> user</label>
      <label><input type="checkbox" checked data-filter="system"> system</label>
      <label><input type="checkbox" checked data-filter="progress"> progress</label>
      <label><input type="checkbox" checked data-filter="unknown"> other</label>
      <span style="color:var(--border)">|</span>
      <label><input type="checkbox" checked id="showStateOverlay"> State overlay</label>
      <input type="text" class="filter-search" id="searchInput" placeholder="Search records...">
    </div>
    <div class="timeline-bar" id="timelineBar"></div>
    <div class="detail-body">
      <div class="record-list" id="recordList"></div>
      <div class="resizer" id="resizer"></div>
      <div class="detail-panel">
        <div class="detail-header">
          <div class="detail-tabs">
            <button class="detail-tab active" data-tab="parsed">Parsed</button>
            <button class="detail-tab" data-tab="state">State</button>
            <button class="detail-tab" data-tab="raw">Raw JSON</button>
          </div>
        </div>
        <div class="detail-content" id="detailContent">
          <div class="detail-placeholder">Select a record to view details</div>
        </div>
      </div>
    </div>
    <div class="detail-legend">
      <div class="legend-item"><div class="legend-swatch" style="background:#79c0ff"></div> Tool start</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#7ee787"></div> Tool done</div>
      <div class="legend-item"><div class="legend-swatch" style="background:#ffa657"></div> Turn end</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--green)"></div> Waiting</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--cyan)"></div> New turn</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--pink)"></div> Permission</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--yellow)"></div> Text-idle</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--red)"></div> Cancel</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--purple)"></div> Subagent</div>
    </div>
  </div>
</div>

<input type="file" id="fileInput" accept=".jsonl" style="display:none">
<input type="file" id="folderInput" webkitdirectory style="display:none">

<script>
// ══════════════════════════════════════════════════════════════
//  Constants
// ══════════════════════════════════════════════════════════════
const TOOL_DONE_DELAY_MS = 300;
const PERMISSION_TIMER_DELAY_MS = 7000;
const TEXT_IDLE_DELAY_MS = 5000;
const PERMISSION_EXEMPT_TOOLS = new Set(['Task', 'AskUserQuestion']);
const CONVO_TRUNCATE_HEIGHT = 260; // px before truncation

// ══════════════════════════════════════════════════════════════
//  App state
// ══════════════════════════════════════════════════════════════
let currentView = 'empty'; // 'empty' | 'sessions' | 'detail'
let sessions = [];          // { name, file?, text, records, conversation, size, lastModified }
let selectedSessionIdx = -1;
let sessionSearchQuery = '';

// Detail view state (for currently-viewed session)
let records = [];
let processedRecords = [];
let selectedRecordIdx = -1;
let activeTab = 'parsed';
let filters = { assistant: true, user: true, system: true, progress: true, unknown: true };
let searchQuery = '';

// ══════════════════════════════════════════════════════════════
//  Elements
// ══════════════════════════════════════════════════════════════
const backBtn = document.getElementById('backBtn');
const hdrPath = document.getElementById('hdrPath');
const hdrStats = document.getElementById('hdrStats');
const viewEmpty = document.getElementById('viewEmpty');
const viewSessions = document.getElementById('viewSessions');
const viewDetail = document.getElementById('viewDetail');
const dropZone = document.getElementById('dropZone');
const sessionsList = document.getElementById('sessionsList');
const sessionCount = document.getElementById('sessionCount');
const sessionSearch = document.getElementById('sessionSearch');
const convoHeader = document.getElementById('convoHeader');
const convoName = document.getElementById('convoName');
const convoBody = document.getElementById('convoBody');
const recordList = document.getElementById('recordList');
const detailContent = document.getElementById('detailContent');
const timelineBar = document.getElementById('timelineBar');
const searchInput = document.getElementById('searchInput');

// ══════════════════════════════════════════════════════════════
//  View management
// ══════════════════════════════════════════════════════════════
function showView(name) {
  currentView = name;
  viewEmpty.classList.toggle('active', name === 'empty');
  viewSessions.classList.toggle('active', name === 'sessions');
  viewDetail.classList.toggle('active', name === 'detail');
  backBtn.style.display = (name === 'detail') ? '' : 'none';
}

backBtn.addEventListener('click', () => {
  if (sessions.length > 0) {
    showView('sessions');
    hdrPath.textContent = sessions._folderPath || '';
    updateSessionStats();
  } else {
    showView('empty');
    hdrPath.textContent = '';
    hdrStats.innerHTML = '';
  }
});

// ══════════════════════════════════════════════════════════════
//  File & folder loading
// ══════════════════════════════════════════════════════════════
document.getElementById('openFolderBtn').addEventListener('click', () => openFolder());
document.getElementById('openFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
document.getElementById('viewJsonlBtn').addEventListener('click', () => openDetailForCurrentSession());

document.getElementById('fileInput').addEventListener('change', (e) => {
  if (e.target.files[0]) loadSingleFile(e.target.files[0]);
  e.target.value = '';
});
document.getElementById('folderInput').addEventListener('change', (e) => {
  loadFilesFromInput(e.target.files);
  e.target.value = '';
});

// Drag & drop (folder or file)
document.body.addEventListener('dragover', (e) => { e.preventDefault(); dropZone?.classList.add('drag-over'); });
document.body.addEventListener('dragleave', (e) => { if (e.target === document.body || e.target === dropZone) dropZone?.classList.remove('drag-over'); });
document.body.addEventListener('drop', async (e) => {
  e.preventDefault();
  dropZone?.classList.remove('drag-over');
  const items = [...(e.dataTransfer?.items || [])];
  // Try folder via webkitGetAsEntry
  for (const item of items) {
    const entry = item.webkitGetAsEntry?.();
    if (entry?.isDirectory) {
      const files = await readDirectoryEntry(entry);
      const jsonlFiles = files.filter(f => f.name.endsWith('.jsonl'));
      if (jsonlFiles.length > 0) {
        await loadFileObjects(jsonlFiles, entry.name);
        return;
      }
    }
  }
  // Fallback: single file
  const file = e.dataTransfer?.files?.[0];
  if (file?.name.endsWith('.jsonl')) loadSingleFile(file);
});

async function openFolder() {
  if (window.showDirectoryPicker) {
    try {
      const handle = await window.showDirectoryPicker();
      const files = [];
      for await (const entry of handle.values()) {
        if (entry.kind === 'file' && entry.name.endsWith('.jsonl')) {
          files.push(await entry.getFile());
        }
      }
      if (files.length > 0) {
        await loadFileObjects(files, handle.name);
      }
    } catch (e) {
      if (e.name !== 'AbortError') console.error(e);
    }
  } else {
    document.getElementById('folderInput').click();
  }
}

function readDirectoryEntry(dirEntry) {
  return new Promise((resolve) => {
    const reader = dirEntry.createReader();
    const allFiles = [];
    let pending = 0;
    let doneReading = false;

    function readBatch() {
      reader.readEntries((entries) => {
        if (entries.length === 0) {
          doneReading = true;
          if (pending === 0) resolve(allFiles);
          return;
        }
        for (const entry of entries) {
          if (entry.isFile && entry.name.endsWith('.jsonl')) {
            pending++;
            entry.file((f) => {
              allFiles.push(f);
              pending--;
              if (doneReading && pending === 0) resolve(allFiles);
            });
          }
        }
        readBatch();
      });
    }
    readBatch();
  });
}

function loadFilesFromInput(fileList) {
  const files = [...fileList].filter(f => f.name.endsWith('.jsonl'));
  if (files.length > 0) loadFileObjects(files, files[0].webkitRelativePath?.split('/')[0] || 'folder');
}

async function loadFileObjects(files, folderName) {
  sessions = [];
  sessions._folderPath = folderName;

  for (const file of files) {
    const text = await file.text();
    const recs = parseJsonlText(text);
    const conversation = extractConversation(recs);
    const turnCount = recs.filter(r => r.type === 'system' && r.subtype === 'turn_duration').length;
    sessions.push({
      name: file.name,
      text,
      records: recs,
      conversation,
      turnCount,
      size: file.size,
      lastModified: file.lastModified,
    });
  }

  // Sort by last modified (newest first)
  sessions.sort((a, b) => b.lastModified - a.lastModified);
  selectedSessionIdx = -1;

  hdrPath.textContent = folderName;
  updateSessionStats();
  renderSessionList();
  showView('sessions');

  // Auto-select first if only one
  if (sessions.length === 1) selectSession(0);
}

function loadSingleFile(file) {
  const reader = new FileReader();
  reader.onload = () => {
    const text = reader.result;
    const recs = parseJsonlText(text);
    const conversation = extractConversation(recs);
    const turnCount = recs.filter(r => r.type === 'system' && r.subtype === 'turn_duration').length;
    sessions = [{
      name: file.name,
      text,
      records: recs,
      conversation,
      turnCount,
      size: file.size,
      lastModified: file.lastModified,
    }];
    sessions._folderPath = '';

    hdrPath.textContent = file.name;
    selectedSessionIdx = 0;
    updateSessionStats();
    renderSessionList();
    showView('sessions');
    selectSession(0);
  };
  reader.readAsText(file);
}

// ══════════════════════════════════════════════════════════════
//  JSONL parsing
// ══════════════════════════════════════════════════════════════
function parseJsonlText(text) {
  const out = [];
  for (const line of text.split('\n')) {
    const t = line.trim();
    if (!t) continue;
    try { out.push(JSON.parse(t)); }
    catch { out.push({ _parseError: true, _raw: t }); }
  }
  return out;
}

// ══════════════════════════════════════════════════════════════
//  Conversation extraction
// ══════════════════════════════════════════════════════════════
function extractConversation(recs) {
  const messages = [];
  let assistantTexts = [];
  let toolsUsed = new Set();
  let assistantIndices = [];
  let turnNumber = 0;

  function flushAssistant() {
    if (assistantTexts.length > 0 || toolsUsed.size > 0) {
      messages.push({
        role: 'assistant',
        text: assistantTexts.join('\n\n'),
        tools: [...toolsUsed],
        recordIndices: [...assistantIndices],
        turn: turnNumber,
      });
    }
    assistantTexts = [];
    toolsUsed = new Set();
    assistantIndices = [];
  }

  for (let i = 0; i < recs.length; i++) {
    const r = recs[i];

    if (r.type === 'user') {
      const content = r.message?.content;
      let userText = '';
      if (typeof content === 'string' && content.trim()) {
        userText = content.trim();
      } else if (Array.isArray(content)) {
        const hasToolResult = content.some(b => b.type === 'tool_result');
        if (!hasToolResult) {
          userText = content.filter(b => b.type === 'text').map(b => b.text || '').join('\n').trim();
        }
      }
      if (userText) {
        flushAssistant();
        turnNumber++;
        messages.push({ role: 'user', text: userText, recordIndex: i, turn: turnNumber });
      }
    } else if (r.type === 'assistant' && Array.isArray(r.message?.content)) {
      for (const block of r.message.content) {
        if (block.type === 'text' && block.text?.trim()) assistantTexts.push(block.text.trim());
        if (block.type === 'tool_use' && block.name) toolsUsed.add(block.name);
      }
      assistantIndices.push(i);
    } else if (r.type === 'system' && r.subtype === 'turn_duration') {
      flushAssistant();
    } else if (r.type === 'progress' && r.data?.type === 'agent_progress') {
      const msg = r.data?.message;
      if (msg?.type === 'assistant' && Array.isArray(msg.message?.content)) {
        for (const block of msg.message.content) {
          if (block.type === 'tool_use' && block.name) toolsUsed.add(block.name);
        }
      }
    }
  }
  flushAssistant();
  return messages;
}

// ══════════════════════════════════════════════════════════════
//  Session list
// ══════════════════════════════════════════════════════════════
function updateSessionStats() {
  const total = sessions.length;
  sessionCount.textContent = total;
  hdrStats.innerHTML = `<span>Sessions: <span class="sv">${total}</span></span>`;
}

sessionSearch.addEventListener('input', () => {
  sessionSearchQuery = sessionSearch.value.toLowerCase();
  renderSessionList();
});

function renderSessionList() {
  sessionsList.innerHTML = '';
  const filtered = sessions.filter((s, i) => {
    if (!sessionSearchQuery) return true;
    const firstPrompt = s.conversation.find(m => m.role === 'user')?.text || '';
    return s.name.toLowerCase().includes(sessionSearchQuery) || firstPrompt.toLowerCase().includes(sessionSearchQuery);
  });

  for (let i = 0; i < sessions.length; i++) {
    const s = sessions[i];
    if (sessionSearchQuery) {
      const firstPrompt = s.conversation.find(m => m.role === 'user')?.text || '';
      if (!s.name.toLowerCase().includes(sessionSearchQuery) && !firstPrompt.toLowerCase().includes(sessionSearchQuery)) continue;
    }
    const card = document.createElement('div');
    card.className = `session-card${i === selectedSessionIdx ? ' selected' : ''}`;
    card.dataset.idx = i;

    const firstPrompt = s.conversation.find(m => m.role === 'user')?.text || '';
    const toolCount = s.records.filter(r => r.type === 'assistant' && Array.isArray(r.message?.content) && r.message.content.some(b => b.type === 'tool_use')).length;

    card.innerHTML = `
      <div class="session-card-name">${esc(s.name)}</div>
      <div class="session-card-meta">
        <span>${s.turnCount} turn${s.turnCount !== 1 ? 's' : ''}</span>
        <span>${toolCount} tool call${toolCount !== 1 ? 's' : ''}</span>
        <span>${formatSize(s.size)}</span>
        <span>${relativeTime(s.lastModified)}</span>
      </div>
      ${firstPrompt ? `<div class="session-card-preview">"${esc(firstPrompt.slice(0, 100))}"</div>` : ''}
    `;
    card.addEventListener('click', () => selectSession(i));
    sessionsList.appendChild(card);
  }
}

function selectSession(idx) {
  selectedSessionIdx = idx;
  sessionsList.querySelectorAll('.session-card').forEach(el => {
    el.classList.toggle('selected', parseInt(el.dataset.idx) === idx);
  });
  renderConversation(sessions[idx]);
}

// ══════════════════════════════════════════════════════════════
//  Conversation preview
// ══════════════════════════════════════════════════════════════
function renderConversation(session) {
  convoHeader.style.display = '';
  convoName.textContent = session.name;

  if (session.conversation.length === 0) {
    convoBody.innerHTML = '<div class="convo-placeholder">No user/assistant messages found</div>';
    return;
  }

  convoBody.innerHTML = '';
  let lastTurn = 0;

  for (const msg of session.conversation) {
    // Turn separator
    if (msg.role === 'user' && msg.turn > 1) {
      const sep = document.createElement('div');
      sep.className = 'convo-turn-sep';
      sep.innerHTML = `<span>Turn ${msg.turn}</span>`;
      convoBody.appendChild(sep);
    }

    const div = document.createElement('div');
    div.className = `convo-msg ${msg.role}`;

    const roleLabel = document.createElement('div');
    roleLabel.className = `convo-msg-role ${msg.role}`;
    roleLabel.textContent = msg.role === 'user' ? 'You' : 'Claude';
    div.appendChild(roleLabel);

    const body = document.createElement('div');
    body.className = 'convo-msg-body';
    body.innerHTML = renderMd(msg.text || '(no text)');
    div.appendChild(body);

    // Truncation
    convoBody.appendChild(div);
    requestAnimationFrame(() => {
      if (body.scrollHeight > CONVO_TRUNCATE_HEIGHT + 40) {
        body.classList.add('convo-msg-truncated');
        const btn = document.createElement('button');
        btn.className = 'convo-expand-btn';
        btn.textContent = 'Show more';
        btn.addEventListener('click', () => {
          body.classList.remove('convo-msg-truncated');
          btn.remove();
        });
        div.appendChild(btn);
      }
    });

    // Tools + jump button
    if (msg.role === 'assistant' && (msg.tools.length > 0 || msg.recordIndices)) {
      const footer = document.createElement('div');
      footer.className = 'convo-tools';
      for (const t of msg.tools) {
        const pill = document.createElement('span');
        pill.className = 'convo-tool-pill';
        pill.textContent = t;
        footer.appendChild(pill);
      }
      // Jump to first record index in JSONL detail
      if (msg.recordIndices?.length > 0) {
        const jumpBtn = document.createElement('button');
        jumpBtn.className = 'convo-jump-btn';
        jumpBtn.textContent = `JSONL #${msg.recordIndices[0]} →`;
        jumpBtn.addEventListener('click', () => {
          openDetailForCurrentSession(msg.recordIndices[0]);
        });
        footer.appendChild(jumpBtn);
      }
      div.appendChild(footer);
    }
    if (msg.role === 'user' && msg.recordIndex != null) {
      const footer = document.createElement('div');
      footer.className = 'convo-tools';
      const jumpBtn = document.createElement('button');
      jumpBtn.className = 'convo-jump-btn';
      jumpBtn.textContent = `JSONL #${msg.recordIndex} →`;
      jumpBtn.addEventListener('click', () => {
        openDetailForCurrentSession(msg.recordIndex);
      });
      footer.appendChild(jumpBtn);
      div.appendChild(footer);
    }

    lastTurn = msg.turn;
  }
}

// Minimal markdown: code blocks, inline code, bold
function renderMd(text) {
  // Escape HTML first
  let out = esc(text);
  // Code blocks: ```lang\ncode\n``` → <pre><code>
  out = out.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code}</code></pre>`);
  // Inline code
  out = out.replace(/`([^`\n]+)`/g, '<code>$1</code>');
  // Bold
  out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  return out;
}

// ══════════════════════════════════════════════════════════════
//  Open JSONL detail for current session
// ══════════════════════════════════════════════════════════════
function openDetailForCurrentSession(jumpToRecord) {
  if (selectedSessionIdx < 0) return;
  const session = sessions[selectedSessionIdx];
  records = session.records;
  processRecords();

  hdrPath.textContent = session.name;
  hdrStats.innerHTML = `
    <span>Records: <span class="sv">${records.length}</span></span>
    <span>Tools: <span class="sv">${records.filter(r => r.type === 'assistant' && Array.isArray(r.message?.content) && r.message.content.some(b => b.type === 'tool_use')).length}</span></span>
    <span>Turns: <span class="sv">${session.turnCount}</span></span>
  `;

  selectedRecordIdx = -1;
  showView('detail');
  renderRecordList();
  renderTimeline();

  if (jumpToRecord != null) {
    requestAnimationFrame(() => selectRecord(jumpToRecord));
  }
}

// ══════════════════════════════════════════════════════════════
//  State Machine Simulation (same as before)
// ══════════════════════════════════════════════════════════════
function processRecords() {
  const state = {
    activeToolIds: new Set(),
    activeToolStatuses: new Map(),
    activeToolNames: new Map(),
    activeSubagentToolIds: new Map(),
    activeSubagentToolNames: new Map(),
    isWaiting: false,
    permissionSent: false,
    hadToolsInTurn: false,
    waitingTimerActive: false,
    permissionTimerActive: false,
  };

  processedRecords = records.map((record, idx) => {
    const events = [];
    const snapshotBefore = cloneState(state);

    if (record._parseError) {
      return { record, index: idx, events, stateBefore: snapshotBefore, stateAfter: cloneState(state) };
    }

    // New data arrival → cancel timers
    if (state.waitingTimerActive) { events.push({ type: 'cancel-waiting', reason: 'New JSONL data arrived → cancel waiting timer' }); state.waitingTimerActive = false; }
    if (state.permissionTimerActive) { events.push({ type: 'cancel-permission', reason: 'New JSONL data arrived → cancel permission timer' }); state.permissionTimerActive = false; }
    if (state.permissionSent) { events.push({ type: 'clear-permission', reason: 'New JSONL data arrived → clear permission bubble' }); state.permissionSent = false; }

    if (record.type === 'assistant' && Array.isArray(record.message?.content)) {
      const blocks = record.message.content;
      const hasToolUse = blocks.some(b => b.type === 'tool_use');
      if (hasToolUse) {
        events.push({ type: 'cancel-waiting', reason: 'assistant has tool_use → cancel waiting timer' });
        state.waitingTimerActive = false;
        state.isWaiting = false;
        state.hadToolsInTurn = true;
        events.push({ type: 'active', reason: 'assistant has tool_use → status=active, hadToolsInTurn=true' });
        let hasNonExempt = false;
        for (const block of blocks) {
          if (block.type === 'tool_use' && block.id) {
            const toolName = block.name || '';
            const status = fmtToolStatus(toolName, block.input || {});
            state.activeToolIds.add(block.id);
            state.activeToolStatuses.set(block.id, status);
            state.activeToolNames.set(block.id, toolName);
            if (!PERMISSION_EXEMPT_TOOLS.has(toolName)) hasNonExempt = true;
            events.push({ type: 'tool-start', toolId: block.id, toolName, status, reason: `Tool start: ${toolName} [${block.id}]` });
          }
        }
        if (hasNonExempt) {
          state.permissionTimerActive = true;
          events.push({ type: 'permission-start', reason: `Permission timer started (${PERMISSION_TIMER_DELAY_MS}ms) — non-exempt tool(s) active` });
        }
      } else if (blocks.some(b => b.type === 'text') && !state.hadToolsInTurn) {
        state.waitingTimerActive = true;
        events.push({ type: 'text-idle-start', reason: `Text-only response, no tools this turn → text-idle timer started (${TEXT_IDLE_DELAY_MS}ms)` });
      }
    } else if (record.type === 'progress') {
      const parentToolId = record.parentToolUseID;
      const data = record.data;
      const dataType = data?.type;
      if (dataType === 'bash_progress' || dataType === 'mcp_progress') {
        if (parentToolId && state.activeToolIds.has(parentToolId)) {
          state.permissionTimerActive = true;
          events.push({ type: 'permission-restart', reason: `${dataType}: tool is executing, restart permission timer` });
        }
      } else if (dataType === 'agent_progress' && parentToolId && state.activeToolNames.get(parentToolId) === 'Task') {
        const msg = data?.message;
        const innerContent = msg?.message?.content;
        if (Array.isArray(innerContent)) {
          if (msg.type === 'assistant') {
            let hasNonExemptSub = false;
            for (const block of innerContent) {
              if (block.type === 'tool_use' && block.id) {
                const tn = block.name || '';
                let s = state.activeSubagentToolIds.get(parentToolId); if (!s) { s = new Set(); state.activeSubagentToolIds.set(parentToolId, s); } s.add(block.id);
                let n = state.activeSubagentToolNames.get(parentToolId); if (!n) { n = new Map(); state.activeSubagentToolNames.set(parentToolId, n); } n.set(block.id, tn);
                if (!PERMISSION_EXEMPT_TOOLS.has(tn)) hasNonExemptSub = true;
                events.push({ type: 'subagent-tool-start', toolId: block.id, toolName: tn, parentToolId, reason: `Subagent tool start: ${tn} [${block.id}]` });
              }
            }
            if (hasNonExemptSub) { state.permissionTimerActive = true; events.push({ type: 'permission-start', reason: 'Permission timer — non-exempt subagent tool(s)' }); }
          } else if (msg.type === 'user') {
            for (const block of innerContent) {
              if (block.type === 'tool_result' && block.tool_use_id) {
                state.activeSubagentToolIds.get(parentToolId)?.delete(block.tool_use_id);
                state.activeSubagentToolNames.get(parentToolId)?.delete(block.tool_use_id);
                events.push({ type: 'subagent-tool-done', toolId: block.tool_use_id, parentToolId, reason: `Subagent tool done: ${block.tool_use_id}` });
              }
            }
            let still = false;
            for (const [, sn] of state.activeSubagentToolNames) { for (const [, tn] of sn) { if (!PERMISSION_EXEMPT_TOOLS.has(tn)) { still = true; break; } } if (still) break; }
            if (still) { state.permissionTimerActive = true; events.push({ type: 'permission-restart', reason: 'Still has non-exempt subagent tools' }); }
          }
        }
      }
    } else if (record.type === 'user') {
      const content = record.message?.content;
      if (Array.isArray(content)) {
        if (content.some(b => b.type === 'tool_result')) {
          for (const block of content) {
            if (block.type === 'tool_result' && block.tool_use_id) {
              const cid = block.tool_use_id;
              if (state.activeToolNames.get(cid) === 'Task') {
                state.activeSubagentToolIds.delete(cid); state.activeSubagentToolNames.delete(cid);
                events.push({ type: 'subagent-clear', toolId: cid, reason: `Task completed → clear subagent` });
              }
              const tn = state.activeToolNames.get(cid);
              state.activeToolIds.delete(cid); state.activeToolStatuses.delete(cid); state.activeToolNames.delete(cid);
              events.push({ type: 'tool-done', toolId: cid, toolName: tn || '?', reason: `Tool done: ${tn || '?'} [${cid}]` });
            }
          }
        } else {
          events.push({ type: 'new-turn', reason: 'User text prompt → new turn' });
          events.push({ type: 'clear-activity', reason: 'clearAgentActivity' });
          state.waitingTimerActive = false; state.activeToolIds.clear(); state.activeToolStatuses.clear(); state.activeToolNames.clear();
          state.activeSubagentToolIds.clear(); state.activeSubagentToolNames.clear();
          state.isWaiting = false; state.permissionSent = false; state.hadToolsInTurn = false;
        }
      } else if (typeof content === 'string' && content.trim()) {
        events.push({ type: 'new-turn', reason: 'User text prompt → new turn' });
        events.push({ type: 'clear-activity', reason: 'clearAgentActivity' });
        state.waitingTimerActive = false; state.activeToolIds.clear(); state.activeToolStatuses.clear(); state.activeToolNames.clear();
        state.activeSubagentToolIds.clear(); state.activeSubagentToolNames.clear();
        state.isWaiting = false; state.permissionSent = false; state.hadToolsInTurn = false;
      }
    } else if (record.type === 'system' && record.subtype === 'turn_duration') {
      events.push({ type: 'turn-end', reason: 'turn_duration → definitive turn end' });
      state.waitingTimerActive = false; state.permissionTimerActive = false;
      if (state.activeToolIds.size > 0) {
        events.push({ type: 'clear-stale-tools', reason: `Clearing ${state.activeToolIds.size} stale tool(s): ${[...state.activeToolNames.values()].join(', ')}` });
        state.activeToolIds.clear(); state.activeToolStatuses.clear(); state.activeToolNames.clear();
        state.activeSubagentToolIds.clear(); state.activeSubagentToolNames.clear();
      }
      state.isWaiting = true; state.permissionSent = false; state.hadToolsInTurn = false;
      events.push({ type: 'waiting', reason: 'isWaiting=true, status=waiting' });
    }

    return { record, index: idx, events: dedup(events), stateBefore: snapshotBefore, stateAfter: cloneState(state) };
  });
}

function dedup(events) {
  const seen = new Set();
  return events.filter(e => {
    if (!e.type.startsWith('cancel-') && e.type !== 'clear-permission') return true;
    if (seen.has(e.type)) return false;
    seen.add(e.type);
    return true;
  });
}

function cloneState(s) {
  return {
    activeToolIds: new Set(s.activeToolIds), activeToolStatuses: new Map(s.activeToolStatuses), activeToolNames: new Map(s.activeToolNames),
    activeSubagentToolIds: new Map([...s.activeSubagentToolIds].map(([k,v])=>[k,new Set(v)])),
    activeSubagentToolNames: new Map([...s.activeSubagentToolNames].map(([k,v])=>[k,new Map(v)])),
    isWaiting: s.isWaiting, permissionSent: s.permissionSent, hadToolsInTurn: s.hadToolsInTurn,
    waitingTimerActive: s.waitingTimerActive, permissionTimerActive: s.permissionTimerActive,
  };
}

function fmtToolStatus(name, input) {
  const base = (p) => typeof p === 'string' ? p.split('/').pop().split('\\').pop() : '';
  switch (name) {
    case 'Read': return `Reading ${base(input.file_path)}`;
    case 'Edit': return `Editing ${base(input.file_path)}`;
    case 'Write': return `Writing ${base(input.file_path)}`;
    case 'Bash': { const c = input.command || ''; return `Running: ${c.length > 30 ? c.slice(0,30)+'…' : c}`; }
    case 'Glob': return 'Searching files';
    case 'Grep': return 'Searching code';
    case 'WebFetch': return 'Fetching web content';
    case 'WebSearch': return 'Searching the web';
    case 'Task': { const d = typeof input.description === 'string' ? input.description : ''; return d ? `Subtask: ${d.length > 40 ? d.slice(0,40)+'…' : d}` : 'Running subtask'; }
    case 'AskUserQuestion': return 'Waiting for your answer';
    case 'EnterPlanMode': return 'Planning';
    case 'NotebookEdit': return 'Editing notebook';
    default: return `Using ${name}`;
  }
}

// ══════════════════════════════════════════════════════════════
//  JSONL Detail View — Record list
// ══════════════════════════════════════════════════════════════
function getRecordType(r) { return r._parseError ? 'unknown' : (r.type || 'unknown'); }
function badgeCls(t) { return `badge-${t === 'assistant'||t === 'user'||t === 'system'||t === 'progress' ? t : 'unknown'}`; }

function summarize(r) {
  if (r._parseError) return { t: 'Parse error', s: r._raw?.slice(0,80) };
  if (r.type === 'assistant' && Array.isArray(r.message?.content)) {
    const c = r.message.content;
    const tools = c.filter(b=>b.type==='tool_use');
    const texts = c.filter(b=>b.type==='text');
    const think = c.filter(b=>b.type==='thinking');
    if (tools.length) return { t: `Tool use: ${tools.map(t=>t.name).join(', ')}`, s: tools.map(t=>fmtToolStatus(t.name,t.input||{})).join(' | ') };
    if (think.length && !texts.length) return { t: 'Thinking', s: think[0].thinking?.slice(0,80)||'' };
    if (texts.length) return { t: 'Text response', s: texts[0].text?.slice(0,80)||'' };
    return { t: 'Assistant message', s: '' };
  }
  if (r.type === 'user') {
    const c = r.message?.content;
    if (Array.isArray(c)) { const tr = c.filter(b=>b.type==='tool_result'); if (tr.length) return { t: `Tool result (${tr.length})`, s: tr.map(t=>t.tool_use_id).join(', ') }; const tx = c.filter(b=>b.type==='text'); if (tx.length) return { t: 'User prompt', s: tx[0].text?.slice(0,80)||'' }; }
    else if (typeof c === 'string') return { t: 'User prompt', s: c.slice(0,80) };
    return { t: 'User message', s: '' };
  }
  if (r.type === 'system') { return r.subtype === 'turn_duration' ? { t: 'Turn duration', s: r.duration_ms ? `${(r.duration_ms/1000).toFixed(1)}s` : '' } : { t: `System: ${r.subtype||''}`, s: '' }; }
  if (r.type === 'progress') {
    const dt = r.data?.type; const pid = r.parentToolUseID||'';
    if (dt === 'bash_progress') return { t: 'Bash progress', s: pid };
    if (dt === 'mcp_progress') return { t: 'MCP progress', s: pid };
    if (dt === 'agent_progress') return { t: `Agent progress (${r.data?.message?.type})`, s: pid };
    return { t: `Progress: ${dt||''}`, s: pid };
  }
  return { t: r.type || 'Unknown', s: JSON.stringify(r).slice(0,60) };
}

function getVisibleRecords() {
  return processedRecords.filter(pr => {
    const t = getRecordType(pr.record);
    const ft = (t==='assistant'||t==='user'||t==='system'||t==='progress') ? t : 'unknown';
    if (!filters[ft]) return false;
    if (searchQuery && !JSON.stringify(pr.record).toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });
}

function renderRecordList() {
  const showOverlay = document.getElementById('showStateOverlay').checked;
  const visible = getVisibleRecords();
  recordList.innerHTML = '';
  for (const pr of visible) {
    const type = getRecordType(pr.record);
    const sm = summarize(pr.record);
    const item = document.createElement('div');
    item.className = `record-item${pr.index === selectedRecordIdx ? ' selected' : ''}`;
    item.dataset.index = pr.index;
    let badges = '';
    if (showOverlay && pr.events.length) {
      const sig = pr.events.filter(e => !e.type.startsWith('cancel-') && e.type !== 'clear-permission');
      if (sig.length) badges = '<div class="state-badges">' + sig.map(e => `<span class="state-badge ${evBadgeCls(e.type)}">${evLabel(e)}</span>`).join('') + '</div>';
    }
    item.innerHTML = `<span class="record-index">${pr.index}</span><span class="record-badge ${badgeCls(type)}">${type}</span><div class="record-summary"><div class="record-summary-text">${esc(sm.t)}</div>${sm.s?`<div class="record-summary-sub">${esc(sm.s)}</div>`:''}${badges}</div>`;
    item.addEventListener('click', () => selectRecord(pr.index));
    recordList.appendChild(item);
  }
}

function evBadgeCls(t) {
  return { 'tool-start':'sb-tool-start','tool-done':'sb-tool-done','turn-end':'sb-turn-end','waiting':'sb-waiting','new-turn':'sb-new-turn','permission-start':'sb-permission-start','permission-restart':'sb-permission-restart','text-idle-start':'sb-text-idle-start','active':'sb-active','cancel-waiting':'sb-cancel-waiting','cancel-permission':'sb-cancel-permission','clear-activity':'sb-clear-activity','clear-permission':'sb-cancel-permission','clear-stale-tools':'sb-clear-activity','subagent-tool-start':'sb-subagent','subagent-tool-done':'sb-subagent','subagent-clear':'sb-subagent' }[t] || '';
}

function evLabel(e) {
  switch(e.type) { case 'tool-start': return `+${e.toolName}`; case 'tool-done': return `-${e.toolName}`; case 'turn-end': return 'TURN END'; case 'waiting': return 'WAITING'; case 'new-turn': return 'NEW TURN'; case 'permission-start': return 'PERM TIMER'; case 'permission-restart': return 'PERM RESTART'; case 'text-idle-start': return 'IDLE TIMER'; case 'active': return 'ACTIVE'; case 'clear-activity': return 'CLEAR ALL'; case 'clear-stale-tools': return 'CLEAR STALE'; case 'subagent-tool-start': return `+sub:${e.toolName}`; case 'subagent-tool-done': return '-sub'; case 'subagent-clear': return 'sub clear'; default: return e.type; }
}

function evIcon(t) {
  return { 'tool-start':'🔧','tool-done':'✅','turn-end':'🏁','waiting':'⏸','new-turn':'▶','permission-start':'⏱','permission-restart':'🔄','text-idle-start':'💤','active':'⚡','cancel-waiting':'❌','cancel-permission':'❌','clear-permission':'❌','clear-activity':'🧹','clear-stale-tools':'🧹','subagent-tool-start':'🔗','subagent-tool-done':'🔗','subagent-clear':'🔗' }[t] || '•';
}

function renderTimeline() {
  timelineBar.innerHTML = '';
  for (let i = 0; i < records.length; i++) {
    const t = getRecordType(records[i]);
    const d = document.createElement('div');
    d.className = `timeline-dot td-${t==='assistant'||t==='user'||t==='system'||t==='progress'?t:'unknown'}${i===selectedRecordIdx?' selected':''}`;
    d.title = `#${i} ${t}`;
    d.addEventListener('click', () => selectRecord(i));
    timelineBar.appendChild(d);
  }
}

function selectRecord(index) {
  selectedRecordIdx = index;
  recordList.querySelectorAll('.record-item').forEach(el => el.classList.toggle('selected', parseInt(el.dataset.index) === index));
  timelineBar.querySelectorAll('.timeline-dot').forEach((d,i) => d.classList.toggle('selected', i === index));
  const item = recordList.querySelector(`.record-item[data-index="${index}"]`);
  if (item) item.scrollIntoView({ block: 'nearest' });
  renderDetailPanel();
}

// ══════════════════════════════════════════════════════════════
//  JSONL Detail View — Detail panel
// ══════════════════════════════════════════════════════════════
function renderDetailPanel() {
  if (selectedRecordIdx < 0 || selectedRecordIdx >= records.length) {
    detailContent.innerHTML = '<div class="detail-placeholder">Select a record to view details</div>';
    return;
  }
  const pr = processedRecords[selectedRecordIdx];
  if (activeTab === 'raw') { detailContent.innerHTML = `<div class="json-tree">${jsonTree(pr.record)}</div>`; setupToggles(); }
  else if (activeTab === 'state') renderStateTab(pr);
  else renderParsedTab(pr);
}

function renderParsedTab(pr) {
  const r = pr.record;
  let h = `<div class="parsed-section"><h3>Record #${pr.index}</h3>`;
  h += `<div class="parsed-field"><span class="parsed-label">Type</span><span class="parsed-value">${esc(r.type||'?')}</span></div>`;
  if (r.subtype) h += `<div class="parsed-field"><span class="parsed-label">Subtype</span><span class="parsed-value">${esc(r.subtype)}</span></div>`;
  if (r.parentToolUseID) h += `<div class="parsed-field"><span class="parsed-label">Parent Tool ID</span><span class="parsed-value" style="font-size:11px">${esc(r.parentToolUseID)}</span></div>`;
  if (r.type === 'system' && r.subtype === 'turn_duration') {
    for (const [k,v] of Object.entries(r)) { if (k==='type'||k==='subtype'||k==='message') continue; h += `<div class="parsed-field"><span class="parsed-label">${esc(k)}</span><span class="parsed-value">${esc(JSON.stringify(v))}</span></div>`; }
  }
  h += '</div>';

  if (r.type === 'assistant' && Array.isArray(r.message?.content)) {
    for (const b of r.message.content) {
      if (b.type === 'tool_use') h += `<div class="tool-block"><div class="tool-block-header"><span class="tool-name">${esc(b.name||'?')}</span><span class="tool-id">${esc(b.id||'')}</span></div><div class="tool-input">${esc(JSON.stringify(b.input||{},null,2))}</div></div>`;
      else if (b.type === 'text') h += `<div class="parsed-section"><h3>Text</h3><div class="text-content">${esc(b.text||'')}</div></div>`;
      else if (b.type === 'thinking') h += `<div class="parsed-section"><h3>Thinking</h3><div class="text-content" style="border-color:#553a88">${esc(b.thinking||'')}</div></div>`;
    }
  }
  if (r.type === 'user') {
    const c = r.message?.content;
    if (Array.isArray(c)) { for (const b of c) { if (b.type === 'tool_result') h += `<div class="tool-block"><div class="tool-block-header"><span class="tool-name" style="color:var(--green)">Tool Result</span><span class="tool-id">${esc(b.tool_use_id||'')}</span>${b.is_error?'<span style="color:var(--red);font-size:12px;font-weight:600">ERROR</span>':''}</div><div class="tool-input">${esc(typeof b.content === 'string' ? b.content : JSON.stringify(b.content,null,2))}</div></div>`; else if (b.type === 'text') h += `<div class="parsed-section"><h3>User Prompt</h3><div class="text-content">${esc(b.text||'')}</div></div>`; } }
    else if (typeof c === 'string') h += `<div class="parsed-section"><h3>User Prompt</h3><div class="text-content">${esc(c)}</div></div>`;
  }
  if (r.type === 'progress') h += `<div class="parsed-section"><h3>Progress Data</h3><div class="tool-input">${esc(JSON.stringify(r.data,null,2))}</div></div>`;

  if (pr.events.length) h += stateEventsHtml(pr);
  detailContent.innerHTML = h;
}

function renderStateTab(pr) {
  let h = '';
  h += pr.events.length ? stateEventsHtml(pr) : '<div class="state-overlay-detail"><h3>State Events</h3><p style="color:var(--text-dim);font-size:13px">No state changes</p></div>';
  h += `<div class="state-overlay-detail"><h3>State Before</h3>${stateSnap(pr.stateBefore)}</div>`;
  h += `<div class="state-overlay-detail"><h3>State After</h3>${stateSnap(pr.stateAfter)}</div>`;
  const diff = stateDiff(pr.stateBefore, pr.stateAfter);
  if (diff.length) h += `<div class="state-overlay-detail"><h3>State Diff</h3><div class="state-snapshot">${diff.map(d=>`<div class="state-field"><span class="state-field-name" style="color:var(--orange)">${esc(d.f)}</span><span>${esc(d.b)} → ${esc(d.a)}</span></div>`).join('')}</div></div>`;
  detailContent.innerHTML = h;
}

function stateEventsHtml(pr) {
  let h = `<div class="state-overlay-detail"><h3>State Events (${pr.events.length})</h3>`;
  for (const e of pr.events) h += `<div class="state-event"><span class="state-event-icon">${evIcon(e.type)}</span><div class="state-event-text"><span class="state-badge ${evBadgeCls(e.type)}" style="font-size:11px">${evLabel(e)}</span><span class="reason">${esc(e.reason)}</span></div></div>`;
  return h + '</div>';
}

function stateSnap(s) {
  let h = '<div class="state-snapshot">';
  for (const f of ['isWaiting','hadToolsInTurn','permissionSent','waitingTimerActive','permissionTimerActive']) h += `<div class="state-field"><span class="state-field-name">${f}</span><span class="${s[f]?'state-true':'state-false'}">${s[f]}</span></div>`;
  if (!s.activeToolIds.size) h += '<div class="state-field"><span class="state-field-name">activeTools</span><span class="state-set-empty">(none)</span></div>';
  else for (const id of s.activeToolIds) h += `<div class="state-field"><span class="state-field-name">tool: ${esc(s.activeToolNames.get(id)||'?')}</span><span class="state-set-items" style="font-size:11px">${esc(id)}</span></div>`;
  for (const [pid, subs] of s.activeSubagentToolIds) for (const sid of subs) h += `<div class="state-field"><span class="state-field-name">subagent: ${esc(s.activeSubagentToolNames.get(pid)?.get(sid)||'?')}</span><span class="state-set-items" style="font-size:11px">parent:${esc(pid)}</span></div>`;
  return h + '</div>';
}

function stateDiff(before, after) {
  const d = [];
  for (const f of ['isWaiting','hadToolsInTurn','permissionSent','waitingTimerActive','permissionTimerActive']) if (before[f] !== after[f]) d.push({ f, b: String(before[f]), a: String(after[f]) });
  const bt = [...before.activeToolIds].sort().join(','), at = [...after.activeToolIds].sort().join(',');
  if (bt !== at) d.push({ f: 'activeTools', b: [...before.activeToolNames.values()].join(', ')||'(none)', a: [...after.activeToolNames.values()].join(', ')||'(none)' });
  return d;
}

// ══════════════════════════════════════════════════════════════
//  JSON tree renderer
// ══════════════════════════════════════════════════════════════
function jsonTree(obj) {
  if (obj === null) return '<span class="json-null">null</span>';
  if (typeof obj === 'boolean') return `<span class="json-boolean">${obj}</span>`;
  if (typeof obj === 'number') return `<span class="json-number">${obj}</span>`;
  if (typeof obj === 'string') { const e = esc(obj); return `<span class="json-string">"${e.length>500?e.slice(0,500)+'…':e}"</span>`; }
  if (Array.isArray(obj)) {
    if (!obj.length) return '<span class="json-bracket">[]</span>';
    const id = 'j'+Math.random().toString(36).slice(2,8);
    return `<span class="json-toggle" data-target="${id}">▼</span><span class="json-bracket">[</span><div class="json-collapsible" id="${id}">${obj.map((v,i)=>`<div style="margin-left:20px">${jsonTree(v)}${i<obj.length-1?',':''}</div>`).join('')}</div><span class="json-bracket">]</span>`;
  }
  if (typeof obj === 'object') {
    const keys = Object.keys(obj);
    if (!keys.length) return '<span class="json-bracket">{}</span>';
    const id = 'j'+Math.random().toString(36).slice(2,8);
    return `<span class="json-toggle" data-target="${id}">▼</span><span class="json-bracket">{</span><div class="json-collapsible" id="${id}">${keys.map((k,i)=>`<div style="margin-left:20px"><span class="json-key">"${esc(k)}"</span>: ${jsonTree(obj[k])}${i<keys.length-1?',':''}</div>`).join('')}</div><span class="json-bracket">}</span>`;
  }
  return esc(String(obj));
}

function setupToggles() {
  detailContent.querySelectorAll('.json-toggle').forEach(t => {
    t.addEventListener('click', () => { const el = document.getElementById(t.dataset.target); if (el) { const c = el.classList.toggle('json-collapsed'); t.textContent = c ? '▶' : '▼'; } });
  });
}

// ══════════════════════════════════════════════════════════════
//  Event listeners
// ══════════════════════════════════════════════════════════════

// Detail tabs
document.querySelectorAll('.detail-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.detail-tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    activeTab = tab.dataset.tab;
    renderDetailPanel();
  });
});

// Detail filters
document.querySelectorAll('.filter-bar input[data-filter]').forEach(cb => {
  cb.addEventListener('change', () => { filters[cb.dataset.filter] = cb.checked; renderRecordList(); });
});
document.getElementById('showStateOverlay').addEventListener('change', () => renderRecordList());
searchInput.addEventListener('input', (e) => { searchQuery = e.target.value; renderRecordList(); });

// Keyboard
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  if (currentView === 'detail') {
    if (e.key === 'ArrowDown' || e.key === 'j') { e.preventDefault(); const v = getVisibleRecords(); const ci = v.findIndex(p=>p.index===selectedRecordIdx); if (ci+1<v.length) selectRecord(v[ci+1].index); }
    else if (e.key === 'ArrowUp' || e.key === 'k') { e.preventDefault(); const v = getVisibleRecords(); const ci = v.findIndex(p=>p.index===selectedRecordIdx); if (ci>0) selectRecord(v[ci-1].index); }
    else if (e.key === '1') { activeTab='parsed'; document.querySelectorAll('.detail-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab==='parsed')); renderDetailPanel(); }
    else if (e.key === '2') { activeTab='state'; document.querySelectorAll('.detail-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab==='state')); renderDetailPanel(); }
    else if (e.key === '3') { activeTab='raw'; document.querySelectorAll('.detail-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab==='raw')); renderDetailPanel(); }
    else if (e.key === 'Escape') backBtn.click();
  } else if (currentView === 'sessions') {
    if (e.key === 'ArrowDown' || e.key === 'j') { e.preventDefault(); if (selectedSessionIdx < sessions.length-1) selectSession(selectedSessionIdx+1); }
    else if (e.key === 'ArrowUp' || e.key === 'k') { e.preventDefault(); if (selectedSessionIdx > 0) selectSession(selectedSessionIdx-1); }
    else if (e.key === 'Enter' && selectedSessionIdx >= 0) openDetailForCurrentSession();
  }
});

// Resizer
let isResizing = false;
document.getElementById('resizer').addEventListener('mousedown', (e) => { isResizing = true; e.preventDefault(); });
document.addEventListener('mousemove', (e) => {
  if (!isResizing) return;
  const rect = document.querySelector('.detail-body').getBoundingClientRect();
  const w = e.clientX - rect.left;
  if (w > 200 && w < window.innerWidth - 300) recordList.style.width = w + 'px';
});
document.addEventListener('mouseup', () => { isResizing = false; });

// ══════════════════════════════════════════════════════════════
//  Helpers
// ══════════════════════════════════════════════════════════════
function esc(s) { if (typeof s !== 'string') s = String(s??''); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function formatSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/(1024*1024)).toFixed(1) + ' MB';
}

function relativeTime(ms) {
  const diff = Date.now() - ms;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'min ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'hr ago';
  if (diff < 604800000) return Math.floor(diff/86400000) + 'd ago';
  return new Date(ms).toLocaleDateString();
}
</script>
</body>
</html>
